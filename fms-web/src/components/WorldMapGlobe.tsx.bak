'use client';

import { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';
import type { LatLngExpression } from 'leaflet';

// react-leaflet 컴포넌트 동적 import (SSR 비활성화)
const MapContainer = dynamic(
  () => import('react-leaflet').then((mod) => mod.MapContainer),
  { ssr: false, loading: () => <MapLoading /> }
);
const TileLayer = dynamic(
  () => import('react-leaflet').then((mod) => mod.TileLayer),
  { ssr: false }
);
const Marker = dynamic(
  () => import('react-leaflet').then((mod) => mod.Marker),
  { ssr: false }
);
const Polyline = dynamic(
  () => import('react-leaflet').then((mod) => mod.Polyline),
  { ssr: false }
);
const Tooltip = dynamic(
  () => import('react-leaflet').then((mod) => mod.Tooltip),
  { ssr: false }
);

// 로딩 컴포넌트
function MapLoading() {
  return (
    <div className="w-full h-[495px] rounded-2xl overflow-hidden bg-[#e5e7eb] flex items-center justify-center">
      <div className="text-white/60 flex items-center gap-2">
        <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
        <span>Loading map...</span>
      </div>
    </div>
  );
}

// 타입 정의
interface Port {
  code: string;
  name: string;
  country: string;
  lat: number;
  lng: number;
  type?: string;
}

interface CargoInfo {
  customer?: string;
  carrier?: string;
  vessel?: string;
  voyageNo?: string;
  tradeType?: string;
  serviceType?: string;
  incoterms?: string;
  etd?: string;
  eta?: string;
  atd?: string;
  ata?: string;
  packages?: number;
  packageType?: string;
  grossWeight?: string | number;
  volume?: string | number;
  value?: string | number;
  currency?: string;
  blNo?: string;
  hblNo?: string;
  mblNo?: string;
}

interface ShipmentRoute {
  id: string;
  shipmentNo: string;
  type: 'sea' | 'air' | 'truck';
  status: string;
  from: Port;
  to: Port;
  progress: number;
  color: string;
  cargo: CargoInfo;
}

interface TrackingStats {
  totalShipments: number;
  inTransit: number;
  seaRoutes: number;
  airRoutes: number;
  activePorts: number;
}

// 곡선 경로 생성
function createCurvedPath(from: [number, number], to: [number, number], numPoints: number = 50): [number, number][] {
  const points: [number, number][] = [];
  for (let i = 0; i <= numPoints; i++) {
    const t = i / numPoints;
    const lat = from[0] + (to[0] - from[0]) * t;
    const lng = from[1] + (to[1] - from[1]) * t;
    const curvature = Math.sin(t * Math.PI) * Math.abs(to[1] - from[1]) * 0.1;
    points.push([lat + curvature, lng]);
  }
  return points;
}

// 경로상의 위치 계산
function getPositionOnPath(path: [number, number][], progress: number): [number, number] {
  const index = Math.floor((progress / 100) * (path.length - 1));
  return path[Math.min(index, path.length - 1)];
}

// 날짜 포맷
function formatDate(dateStr: string | undefined): string {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

// 숫자 포맷
function formatNumber(num: string | number | undefined): string {
  if (!num) return '-';
  const n = typeof num === 'string' ? parseFloat(num) : num;
  return n.toLocaleString('ko-KR');
}

// 선적정보 팝업 컴포넌트
function ShipmentPopup({
  route,
  onClose,
  onBlClick,
}: {
  route: ShipmentRoute;
  onClose: () => void;
  onBlClick: (blNo: string) => void;
}) {
  const getTypeLabel = (type: string) => {
    switch (type) {
      case 'sea': return '해상운송';
      case 'air': return '항공운송';
      case 'truck': return '내륙운송';
      default: return type;
    }
  };

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; color: string }> = {
      'BOOKED': { label: '예약', color: 'bg-blue-500' },
      'DEPARTED': { label: '출발', color: 'bg-orange-500' },
      'SHIPPED': { label: '운송중', color: 'bg-teal-500' },
      'IN_TRANSIT': { label: '운송중', color: 'bg-teal-500' },
      'ARRIVED': { label: '도착', color: 'bg-green-500' },
    };
    const s = statusMap[status] || { label: status, color: 'bg-gray-500' };
    return <span className={`px-2 py-0.5 rounded text-xs text-white ${s.color}`}>{s.label}</span>;
  };

  return (
    <div className="fixed inset-0 z-[2000] flex items-center justify-center" onClick={onClose}>
      <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" />
      <div
        className="relative bg-white rounded-2xl shadow-2xl w-[624px] max-h-[85vh] overflow-auto"
        onClick={(e) => e.stopPropagation()}
      >
        {/* 헤더 */}
        <div className="sticky top-0 bg-gradient-to-r from-[#1A2744] to-[#243B67] text-white p-4 rounded-t-2xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2">
                <span className="text-lg font-bold">{route.shipmentNo}</span>
                {getStatusBadge(route.status)}
              </div>
              <div className="text-sm text-white/70 mt-1">{getTypeLabel(route.type)}</div>
            </div>
            <button
              onClick={onClose}
              className="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* 컨텐츠 */}
        <div className="p-4 space-y-4">
          {/* 경로 정보 */}
          <div className="bg-gray-50 rounded-xl p-4">
            <div className="flex items-center justify-between">
              <div className="text-center">
                <div className="text-xs text-gray-500 mb-1">출발지</div>
                <div className="font-bold text-gray-800">{route.from.name}</div>
                <div className="text-xs text-gray-500">{route.from.code}</div>
              </div>
              <div className="flex-1 mx-4">
                <div className="relative">
                  <div className="h-1 bg-gray-200 rounded-full">
                    <div
                      className="h-1 rounded-full transition-all duration-300"
                      style={{ width: `${route.progress}%`, backgroundColor: route.color }}
                    />
                  </div>
                  <div className="text-center text-xs text-gray-500 mt-1">{route.progress}%</div>
                </div>
              </div>
              <div className="text-center">
                <div className="text-xs text-gray-500 mb-1">도착지</div>
                <div className="font-bold text-gray-800">{route.to.name}</div>
                <div className="text-xs text-gray-500">{route.to.code}</div>
              </div>
            </div>
          </div>

          {/* B/L 정보 */}
          {(route.cargo.blNo || route.cargo.hblNo || route.cargo.mblNo || route.shipmentNo) && (
            <div className="border rounded-xl p-4">
              <div className="text-sm font-semibold text-gray-700 mb-3">B/L 정보</div>
              <div className="space-y-2">
                {route.cargo.mblNo && (
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-500">MBL No.</span>
                    <button
                      onClick={() => onBlClick(route.cargo.mblNo!)}
                      className="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline"
                    >
                      {route.cargo.mblNo}
                    </button>
                  </div>
                )}
                {route.cargo.hblNo && (
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-500">HBL No.</span>
                    <button
                      onClick={() => onBlClick(route.cargo.hblNo!)}
                      className="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline"
                    >
                      {route.cargo.hblNo}
                    </button>
                  </div>
                )}
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-500">Shipment No.</span>
                  <button
                    onClick={() => onBlClick(route.id)}
                    className="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline"
                  >
                    {route.shipmentNo}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 기본 정보 */}
          <div className="grid grid-cols-2 gap-4">
            <div className="border rounded-xl p-4">
              <div className="text-sm font-semibold text-gray-700 mb-3">일정 정보</div>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-500">ETD</span>
                  <span className="font-medium">{formatDate(route.cargo.etd)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">ETA</span>
                  <span className="font-medium">{formatDate(route.cargo.eta)}</span>
                </div>
                {route.cargo.atd && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">ATD</span>
                    <span className="font-medium text-green-600">{formatDate(route.cargo.atd)}</span>
                  </div>
                )}
                {route.cargo.ata && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">ATA</span>
                    <span className="font-medium text-green-600">{formatDate(route.cargo.ata)}</span>
                  </div>
                )}
              </div>
            </div>

            <div className="border rounded-xl p-4">
              <div className="text-sm font-semibold text-gray-700 mb-3">화물 정보</div>
              <div className="space-y-2 text-sm">
                {route.cargo.packages && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">수량</span>
                    <span className="font-medium">{formatNumber(route.cargo.packages)} {route.cargo.packageType || 'PKG'}</span>
                  </div>
                )}
                {route.cargo.grossWeight && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">중량</span>
                    <span className="font-medium">{formatNumber(route.cargo.grossWeight)} kg</span>
                  </div>
                )}
                {route.cargo.volume && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">체적</span>
                    <span className="font-medium">{formatNumber(route.cargo.volume)} CBM</span>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* 거래 정보 */}
          <div className="border rounded-xl p-4">
            <div className="text-sm font-semibold text-gray-700 mb-3">거래 정보</div>
            <div className="grid grid-cols-2 gap-2 text-sm">
              {route.cargo.customer && (
                <div className="flex justify-between">
                  <span className="text-gray-500">고객사</span>
                  <span className="font-medium">{route.cargo.customer}</span>
                </div>
              )}
              {route.cargo.carrier && (
                <div className="flex justify-between">
                  <span className="text-gray-500">운송사</span>
                  <span className="font-medium">{route.cargo.carrier}</span>
                </div>
              )}
              {route.cargo.vessel && (
                <div className="flex justify-between">
                  <span className="text-gray-500">선박/항공편</span>
                  <span className="font-medium">{route.cargo.vessel}</span>
                </div>
              )}
              {route.cargo.incoterms && (
                <div className="flex justify-between">
                  <span className="text-gray-500">Incoterms</span>
                  <span className="font-medium">{route.cargo.incoterms}</span>
                </div>
              )}
              {route.cargo.value && (
                <div className="flex justify-between">
                  <span className="text-gray-500">신고가액</span>
                  <span className="font-medium">{route.cargo.currency} {formatNumber(route.cargo.value)}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* 푸터 */}
        <div className="sticky bottom-0 bg-gray-50 p-4 rounded-b-2xl border-t">
          <button
            onClick={() => onBlClick(route.id)}
            className="w-full py-2.5 bg-[#1A2744] hover:bg-[#243B67] text-white rounded-lg font-medium transition-colors"
          >
            상세 조회
          </button>
        </div>
      </div>
    </div>
  );
}

// Leaflet 지도 컴포넌트
function LeafletMap() {
  const router = useRouter();
  const [routes, setRoutes] = useState<ShipmentRoute[]>([]);
  const [ports, setPorts] = useState<Port[]>([]);
  const [stats, setStats] = useState<TrackingStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [animationProgress, setAnimationProgress] = useState(0);
  const [selectedRoute, setSelectedRoute] = useState<ShipmentRoute | null>(null);
  const [isClient, setIsClient] = useState(false);
  const [L, setL] = useState<typeof import('leaflet') | null>(null);

  useEffect(() => {
    setIsClient(true);
    import('leaflet').then((leaflet) => setL(leaflet));
  }, []);

  // 데이터 가져오기
  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await fetch('/api/shipments/tracking');
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        setRoutes(data.routes || []);
        setPorts(data.ports || []);
        setStats(data.stats || null);
        setLoading(false);
      } catch (err) {
        setError('데이터를 불러오는데 실패했습니다.');
        setLoading(false);
      }
    };
    fetchData();
    const interval = setInterval(fetchData, 30000);
    return () => clearInterval(interval);
  }, []);

  // 애니메이션
  useEffect(() => {
    const interval = setInterval(() => {
      setAnimationProgress((prev) => (prev + 0.2) % 100);
    }, 50);
    return () => clearInterval(interval);
  }, []);

  // B/L 클릭 핸들러
  const handleBlClick = useCallback((routeId: string) => {
    setSelectedRoute(null);
    // shipment ID 추출 (shipment-14 -> 14)
    const shipmentId = routeId.replace('shipment-', '').replace('sn-', '');
    router.push(`/logis/shipment/${shipmentId}`);
  }, [router]);

  // 선박 아이콘 (해상운송)
  const createShipIcon = useCallback((color: string, size: number, isHovered: boolean = false) => {
    if (!L) return undefined;
    const actualSize = isHovered ? size * 1.3 : size;
    const glow = isHovered ? '20px' : '10px';

    return L.divIcon({
      html: `<div style="
        width: ${actualSize}px; height: ${actualSize}px;
        background: ${color}; border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 ${glow} ${color}, 0 0 20px ${color}80;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
      ">
        <svg width="${actualSize * 0.6}" height="${actualSize * 0.6}" viewBox="0 0 24 24" fill="white">
          <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.05.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
        </svg>
      </div>`,
      className: 'custom-marker',
      iconSize: [actualSize, actualSize],
      iconAnchor: [actualSize / 2, actualSize / 2],
    });
  }, [L]);

  // 비행기 아이콘 (항공운송)
  const createAirplaneIcon = useCallback((color: string, size: number, isHovered: boolean = false) => {
    if (!L) return undefined;
    const actualSize = isHovered ? size * 1.3 : size;
    const glow = isHovered ? '20px' : '10px';

    return L.divIcon({
      html: `<div style="
        width: ${actualSize}px; height: ${actualSize}px;
        background: ${color}; border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 ${glow} ${color}, 0 0 20px ${color}80;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
      ">
        <svg width="${actualSize * 0.6}" height="${actualSize * 0.6}" viewBox="0 0 24 24" fill="white">
          <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
        </svg>
      </div>`,
      className: 'custom-marker',
      iconSize: [actualSize, actualSize],
      iconAnchor: [actualSize / 2, actualSize / 2],
    });
  }, [L]);

  // 트럭 아이콘 (내륙운송)
  const createTruckIcon = useCallback((color: string, size: number, isHovered: boolean = false) => {
    if (!L) return undefined;
    const actualSize = isHovered ? size * 1.3 : size;
    const glow = isHovered ? '20px' : '10px';

    return L.divIcon({
      html: `<div style="
        width: ${actualSize}px; height: ${actualSize}px;
        background: ${color}; border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 ${glow} ${color}, 0 0 20px ${color}80;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
      ">
        <svg width="${actualSize * 0.6}" height="${actualSize * 0.6}" viewBox="0 0 24 24" fill="white">
          <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </svg>
      </div>`,
      className: 'custom-marker',
      iconSize: [actualSize, actualSize],
      iconAnchor: [actualSize / 2, actualSize / 2],
    });
  }, [L]);

  // 항구 마커 아이콘
  const createPortIcon = useCallback((color: string, size: number) => {
    if (!L) return undefined;
    return L.divIcon({
      html: `<div style="
        width: ${size}px; height: ${size}px;
        background: ${color}; border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 8px ${color}, 0 2px 4px rgba(0,0,0,0.3);
      "></div>`,
      className: 'custom-marker',
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
    });
  }, [L]);

  // 운송 유형별 아이콘 선택
  const getTransportIcon = useCallback((route: ShipmentRoute, isHovered: boolean = false) => {
    const size = 28;
    switch (route.type) {
      case 'air':
        return createAirplaneIcon(route.color, size, isHovered);
      case 'truck':
        return createTruckIcon(route.color, size, isHovered);
      case 'sea':
      default:
        return createShipIcon(route.color, size, isHovered);
    }
  }, [createShipIcon, createAirplaneIcon, createTruckIcon]);

  if (!isClient || !L) return <MapLoading />;
  if (loading) return <MapLoading />;
  if (error) {
    return (
      <div className="w-full h-[495px] rounded-2xl overflow-hidden bg-[#e5e7eb] flex items-center justify-center">
        <div className="text-red-400">{error}</div>
      </div>
    );
  }

  return (
    <div className="relative w-full h-[495px] rounded-2xl overflow-hidden">
      <MapContainer
        center={[25, 80] as LatLngExpression}
        zoom={2}
        minZoom={2}
        maxZoom={6}
        style={{ height: '100%', width: '100%' }}
        zoomControl={false}
        attributionControl={false}
        scrollWheelZoom={true}
        dragging={true}
      >
        <TileLayer url="https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png" />

        {/* 항로 - 배경 점선 */}
        {routes.map((route) => {
          const path = createCurvedPath([route.from.lat, route.from.lng], [route.to.lat, route.to.lng]);
          return (
            <Polyline
              key={`${route.id}-bg`}
              positions={path as LatLngExpression[]}
              pathOptions={{ color: route.color, weight: 2, opacity: 0.3, dashArray: '10, 10' }}
            />
          );
        })}

        {/* 항로 - 진행 라인 */}
        {routes.map((route) => {
          const path = createCurvedPath([route.from.lat, route.from.lng], [route.to.lat, route.to.lng]);
          const animatedProgress = (route.progress + animationProgress * 0.5) % 100;
          return (
            <Polyline
              key={`${route.id}-progress`}
              positions={path.slice(0, Math.floor((animatedProgress / 100) * path.length) + 1) as LatLngExpression[]}
              pathOptions={{ color: route.color, weight: 3, opacity: 0.8 }}
            />
          );
        })}

        {/* 운송 마커 (선박/비행기/트럭) */}
        {routes.map((route) => {
          const path = createCurvedPath([route.from.lat, route.from.lng], [route.to.lat, route.to.lng]);
          const animatedProgress = (route.progress + animationProgress * 0.5) % 100;
          const position = getPositionOnPath(path, animatedProgress);

          return (
            <Marker
              key={`${route.id}-vehicle`}
              position={position as LatLngExpression}
              icon={getTransportIcon(route, selectedRoute?.id === route.id)}
              eventHandlers={{
                click: () => setSelectedRoute(route),
              }}
            >
              <Tooltip direction="top" offset={[0, -15]} className="custom-tooltip" permanent={false} sticky={false}>
                <div className="p-3 bg-white rounded-xl shadow-lg min-w-[300px]">
                  {/* 헤더 */}
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-bold text-gray-800 text-base">{route.shipmentNo}</div>
                    <span className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: route.color }}>
                      {route.type === 'air' ? '항공' : route.type === 'truck' ? '내륙' : '해상'}
                    </span>
                  </div>
                  <div className="text-sm text-gray-500">{route.from.name} → {route.to.name}</div>

                  {/* B/L 정보 */}
                  <div className="mt-2 pt-2 border-t border-gray-100">
                    <div className="text-xs font-semibold text-gray-600 mb-1">B/L Information</div>
                    <div className="text-sm flex justify-between">
                      <span className="text-gray-400">MBL No.</span>
                      <span className="font-medium text-blue-600">{route.cargo.mblNo || 'HDMU' + route.id.replace(/\D/g, '').padStart(7, '0')}</span>
                    </div>
                    <div className="text-sm flex justify-between">
                      <span className="text-gray-400">HBL No.</span>
                      <span className="font-medium text-blue-600">{route.cargo.hblNo || 'SHBL' + route.id.replace(/\D/g, '').padStart(7, '0')}</span>
                    </div>
                  </div>

                  {/* 화주 정보 */}
                  <div className="mt-2 pt-2 border-t border-gray-100">
                    <div className="text-xs font-semibold text-gray-600 mb-1">Shipper Info</div>
                    <div className="text-sm flex justify-between">
                      <span className="text-gray-400">화주</span>
                      <span className="font-medium text-gray-700">{route.cargo.customer || '삼성전자'}</span>
                    </div>
                    <div className="text-sm flex justify-between">
                      <span className="text-gray-400">운송사</span>
                      <span className="font-medium text-gray-700">{route.cargo.carrier || 'HMM'}</span>
                    </div>
                  </div>

                  {/* 물품 정보 */}
                  <div className="mt-2 pt-2 border-t border-gray-100">
                    <div className="text-xs font-semibold text-gray-600 mb-1">Cargo Info</div>
                    <div className="grid grid-cols-2 gap-1 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-400">수량</span>
                        <span className="font-medium">{route.cargo.packages || 100} {route.cargo.packageType || 'PKG'}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">중량</span>
                        <span className="font-medium">{formatNumber(route.cargo.grossWeight) || '5,000'} kg</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">체적</span>
                        <span className="font-medium">{formatNumber(route.cargo.volume) || '25'} CBM</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">진행률</span>
                        <span className="font-medium text-green-600">{route.progress}%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </Tooltip>
            </Marker>
          );
        })}

        {/* 항구 마커 */}
        {ports.map((port) => {
          const activeCount = routes.filter(r => r.from.code === port.code || r.to.code === port.code).length;
          const isActive = activeCount > 0;
          return (
            <Marker
              key={port.code}
              position={[port.lat, port.lng] as LatLngExpression}
              icon={createPortIcon(isActive ? '#E8A838' : '#64748b', isActive ? 12 : 8)}
            >
              <Tooltip direction="top" offset={[0, -8]} permanent={false} sticky={false}>
                <div className="p-2 bg-white rounded-lg min-w-[120px]">
                  <div className="font-bold text-gray-800">{port.name}</div>
                  <div className="text-xs text-gray-500">{port.code} | {port.country}</div>
                  {isActive && (
                    <div className="text-xs mt-1 text-[#E8A838] font-medium">{activeCount} Active</div>
                  )}
                </div>
              </Tooltip>
            </Marker>
          );
        })}
      </MapContainer>

      {/* 범례 */}
      <div className="absolute bottom-3 left-3 flex gap-2 z-[1000]">
        <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <svg className="w-4 h-4 text-[#E8A838]" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2z"/>
          </svg>
          <span className="text-[11px] text-white/90 font-medium">해상</span>
        </div>
        <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <svg className="w-4 h-4 text-[#F97316]" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
          </svg>
          <span className="text-[11px] text-white/90 font-medium">항공</span>
        </div>
        <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <svg className="w-4 h-4 text-[#22C55E]" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4z"/>
          </svg>
          <span className="text-[11px] text-white/90 font-medium">내륙</span>
        </div>
      </div>

      {/* 통계 */}
      <div className="absolute top-3 right-3 flex gap-2 z-[1000]">
        <div className="px-3 py-2 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <div className="text-[10px] text-white/60 uppercase">Total</div>
          <div className="text-xl font-bold text-[#E8A838]">{stats?.totalShipments || 0}</div>
        </div>
        <div className="px-3 py-2 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <div className="text-[10px] text-white/60 uppercase">In Transit</div>
          <div className="text-xl font-bold text-[#14D4CE]">{stats?.inTransit || 0}</div>
        </div>
        <div className="px-3 py-2 rounded-lg backdrop-blur-md" style={{ background: 'rgba(0,0,0,0.7)' }}>
          <div className="text-[10px] text-white/60 uppercase">Ports</div>
          <div className="text-xl font-bold text-white">{stats?.activePorts || 0}</div>
        </div>
      </div>

      {/* 실시간 표시 */}
      <div className="absolute top-3 left-3 flex items-center gap-2 px-3 py-1.5 rounded-lg backdrop-blur-md z-[1000]" style={{ background: 'rgba(0,0,0,0.7)' }}>
        <span className="relative flex h-2 w-2">
          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        <span className="text-[11px] text-white/90 font-medium">Live Tracking</span>
      </div>

      {/* 데이터 없음 */}
      {routes.length === 0 && (
        <div className="absolute inset-0 flex items-center justify-center z-[500] pointer-events-none">
          <div className="px-4 py-2 rounded-lg backdrop-blur-md text-white/60 text-sm" style={{ background: 'rgba(0,0,0,0.5)' }}>
            표시할 선적 데이터가 없습니다
          </div>
        </div>
      )}

      {/* 선적정보 팝업 */}
      {selectedRoute && (
        <ShipmentPopup
          route={selectedRoute}
          onClose={() => setSelectedRoute(null)}
          onBlClick={handleBlClick}
        />
      )}
    </div>
  );
}

export default function WorldMapGlobe() {
  return <LeafletMap />;
}
