# 태평양 횡단 경로 표시 문제 해결 설계서

## 1. 문제 분석

### 1.1 현재 상태 (스크린샷 분석)

```
┌─────────────────────────────────────────────────────────────────────┐
│                        현재 지도 상태                                 │
├─────────────────────────────────────────────────────────────────────┤
│  [유럽잘림] [아시아] [태평양] [미국] [동해안]                          │
│     ↑                                      ↑                        │
│   왼쪽 끝                              오른쪽 끝                      │
│                                                                      │
│  문제점:                                                             │
│  1. 세계지도가 왼쪽으로 치우침 (유럽이 잘림)                           │
│  2. 아이콘이 경로와 다른 위치에 표시                                   │
│  3. 일부 경로가 태평양 중간에서 끊김                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 문제 원인

#### 문제 1: 지도 중심 위치 (center: [30, 180])
- 날짜변경선(180°)이 화면 중앙에 위치
- 결과: 유럽/아프리카가 화면 왼쪽 끝에서 잘림
- 세계지도가 "완전하게" 표시되지 않음

#### 문제 2: 마커 위치 정규화 (`getPositionOnPath` 함수)
```typescript
// 현재 코드 (631-640행)
function getPositionOnPath(path, progress) {
  const pos = path[index];
  let lng = pos[1];
  while (lng > 180) lng -= 360;   // ❌ 문제: 경도 정규화
  while (lng < -180) lng += 360;  // ❌ 마커가 경로와 다른 위치로 이동
  return [pos[0], lng];
}
```

- **경로 좌표**: 129° → 180° → 230° (연속)
- **마커 좌표**: 230° → -130° (정규화됨)
- **결과**: 마커가 경로와 완전히 다른 위치에 표시됨!

#### 문제 3: 경로 연속성
- 경로는 180°를 넘어가도록 설계됨
- 하지만 마커 정규화로 인해 불일치 발생

---

## 2. 해결 설계

### 2.1 지도 중심 조정

```
┌─────────────────────────────────────────────────────────────────────┐
│                     제안: center [20, 150]                           │
├─────────────────────────────────────────────────────────────────────┤
│  [유럽] [아프리카] [아시아] [태평양] [미국]                            │
│    ↑                   ↑                 ↑                          │
│  왼쪽                 중앙              오른쪽                        │
│                                                                      │
│  장점:                                                               │
│  - 세계지도가 균형있게 표시                                           │
│  - 한국→미국 경로가 왼쪽→오른쪽으로 자연스럽게 표시                    │
│  - 유럽도 완전히 보임                                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 마커 위치 계산 수정

```typescript
// 수정된 getPositionOnPath 함수
function getPositionOnPath(path: [number, number][], progress: number): [number, number] {
  const index = Math.floor((progress / 100) * (path.length - 1));
  const pos = path[Math.min(index, path.length - 1)];

  // ✅ 경로 좌표 그대로 반환 (정규화 제거)
  // Leaflet이 180°를 넘는 좌표도 올바르게 처리함
  return [pos[0], pos[1]];
}
```

### 2.3 전체 시스템 좌표 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                    수정된 좌표 흐름                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  [경로 생성]                                                         │
│      │                                                               │
│      ▼                                                               │
│  createOptimalRoutePath()                                            │
│      │ 좌표: 129° → 150° → 180° → 210° → 242°                       │
│      ▼                                                               │
│  adjustPathForPacificCrossing()                                      │
│      │ 좌표: 연속 유지 (정규화 없음)                                  │
│      ▼                                                               │
│  ┌─────────────────────┬─────────────────────┐                      │
│  │     Polyline        │      Marker          │                      │
│  │ 경로: 129°→242°     │ 위치: 경로상의 좌표   │                      │
│  │ (연속 표시)         │ (정규화 없음!)        │                      │
│  └─────────────────────┴─────────────────────┘                      │
│                                                                      │
│  결과: 경로와 마커가 항상 동일 위치에 표시                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 수정 대상 코드

### 3.1 MapContainer center 변경

**파일**: `src/components/WorldMapGlobe.tsx`
**위치**: 1193행

```typescript
// Before
center={[30, 180] as LatLngExpression}

// After
center={[20, 150] as LatLngExpression}
```

### 3.2 MapResetControl setView 변경

**파일**: `src/components/WorldMapGlobe.tsx`
**위치**: 40행

```typescript
// Before
map.setView([30, 180], 2, { animate: true, duration: 0.5 });

// After
map.setView([20, 150], 2, { animate: true, duration: 0.5 });
```

### 3.3 getPositionOnPath 함수 수정

**파일**: `src/components/WorldMapGlobe.tsx`
**위치**: 631-640행

```typescript
// Before
function getPositionOnPath(path: [number, number][], progress: number): [number, number] {
  const index = Math.floor((progress / 100) * (path.length - 1));
  const pos = path[Math.min(index, path.length - 1)];
  // 경도 정규화 (마커 위치용)
  let lng = pos[1];
  while (lng > 180) lng -= 360;
  while (lng < -180) lng += 360;
  return [pos[0], lng];
}

// After
function getPositionOnPath(path: [number, number][], progress: number): [number, number] {
  const index = Math.floor((progress / 100) * (path.length - 1));
  const pos = path[Math.min(index, path.length - 1)];

  // 경로 좌표 그대로 반환 - 마커가 경로 위에 정확히 표시됨
  // Leaflet은 180°를 넘는 좌표도 올바르게 처리함
  return [pos[0], pos[1]];
}
```

---

## 4. 예상 결과

### 4.1 수정 전

```
┌─────────────────────────────────────────────────────────────────────┐
│                         수정 전                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   [경로]  한국 ─────────────────────────────────→ 미국               │
│           129°        180°         242°(-118°)                      │
│                                                                      │
│   [마커]        ✈️                                ✈️                  │
│              (정규화됨)                        (정규화됨)             │
│              -130°                            -118°                  │
│                                                                      │
│   문제: 마커가 경로의 다른 위치에 표시됨                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 수정 후

```
┌─────────────────────────────────────────────────────────────────────┐
│                         수정 후                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   [경로]  한국 ───✈️────────────────✈️────────→ 미국                 │
│           129°    150°    180°    210°    242°                      │
│                                                                      │
│   마커와 경로가 정확히 일치!                                          │
│                                                                      │
│   지도: 세계 전체가 균형있게 표시                                      │
│   - 유럽 (완전히 보임)                                                │
│   - 아시아 (중앙 근처)                                                │
│   - 태평양 (중앙)                                                     │
│   - 미국 (오른쪽)                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 구현 체크리스트

- [ ] MapContainer center 변경: [30, 180] → [20, 150]
- [ ] MapResetControl setView 변경: [30, 180] → [20, 150]
- [ ] getPositionOnPath 정규화 로직 제거
- [ ] 브라우저 테스트 실행
- [ ] 스크린샷 확인

---

## 6. 테스트 시나리오

### 6.1 기본 테스트
1. 페이지 로드 시 세계지도가 중앙에 균형있게 표시되는지 확인
2. 유럽, 아프리카, 아시아, 태평양, 미국이 모두 보이는지 확인

### 6.2 경로 테스트
1. 한국 → 미국 해상 경로가 태평양을 건너 연속으로 표시되는지 확인
2. 한국 → 미국 항공 경로가 끊김 없이 표시되는지 확인

### 6.3 마커 테스트
1. 선박/비행기 아이콘이 경로 위에 정확히 위치하는지 확인
2. 애니메이션 진행 시 아이콘이 경로를 따라 이동하는지 확인
3. 태평양 중간에서 아이콘이 사라지지 않는지 확인

### 6.4 초기화 테스트
1. "초기화" 버튼 클릭 시 올바른 위치로 리셋되는지 확인

---

## 승인 요청

위 설계 내용을 검토 후 승인해 주시면 구현을 시작하겠습니다.

**핵심 수정 사항:**
1. 지도 중심을 [20, 150]으로 변경 (세계지도 균형)
2. 마커 좌표 정규화 제거 (경로와 일치)
3. 초기화 버튼 위치도 동일하게 변경
